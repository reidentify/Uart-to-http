<button>Test</button>

<script>
	
// 打开串行端口
async function connectSerial() {
    const port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });

    const reader = port.readable.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = '';

    try {
        while (true) {
            const { value, done } = await reader.read();
            if (done) {
                // 当读取器被取消时，跳出循环
                break;
            }
            // 将接收到的Uint8Array数据解码为字符串
            const text = decoder.decode(value, {stream: true});
            buffer += text;

            // 处理接收到的每一行数据
            let eolIndex;
            while ((eolIndex = buffer.indexOf('\r\n')) >= 0) {
                const line = buffer.slice(0, eolIndex); // 获取一行数据
                buffer = buffer.slice(eolIndex + 2);    // 移除这行数据，包括\r\n
                processLine(line);                      // 处理行数据
            }
        }
    } catch (error) {
        console.error(error);
    } finally {
        reader.releaseLock();
    }
}

// 处理每一行数据，添加时间戳并输出
function processLine(line) {
    const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
    console.log(`[${timestamp}] >>${line}`);
}

// 添加按钮点击事件监听器，启动连接
document.querySelector('button').addEventListener('click', connectSerial);
</script>