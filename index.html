<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UART数据接收</title>
</head>
<body>
    <button id="startButton">开始接收数据</button>
    <button id="stopButton" disabled>停止接收数据</button>
    <div id="console"></div>

    <script>
        let port;
        let reader;
        const consoleDiv = document.getElementById('console');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');

        startButton.addEventListener('click', async () => {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                reader = port.readable.getReader();
                startButton.disabled = true;
                stopButton.disabled = false;
                readLoop();
            } catch (error) {
                console.error('无法获取串行端口权限：', error);
                consoleDiv.innerHTML += `无法获取串行端口权限：${error}<br>`;
            }
        });
		
        stopButton.addEventListener('click', async () => 	//
		{
            if (reader) {
                await reader.cancel();
                await port.close();
                reader = null;
                startButton.disabled = false;
                stopButton.disabled = true;
            }
        });

        async function readLoop() {
            while (true) {
                try {
                    const { value, done } = await reader.read();
                    if (done) {
                        console.log('接收结束');
                        reader.releaseLock();
                        break;
                    }
                    const decoder = new TextDecoderStream();
                    const readableStreamClosed = value.pipeTo(decoder.writable);
                    const decodedStream = decoder.readable;
                    const reader = decodedStream.getReader();
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) {
                            console.log('流结束');
                            reader.releaseLock();
                            break;
                        }
                        const timestamp = new Date().toLocaleTimeString();
                        const hexData = value.reduce((str, byte) => str + byte.toString(16).padStart(2, '0').toUpperCase() + ' ', '');
                        const decodedData = new TextDecoder().decode(value);
                        consoleDiv.innerHTML += `[${timestamp}] ${hexData} >> ${decodedData}<br>`;
                    }
                } catch (error) {
                    console.error('读取错误：', error);
                    consoleDiv.innerHTML += `读取错误：${error}<br>`;
                }
            }
        }
    </script>
</body>
</html>
