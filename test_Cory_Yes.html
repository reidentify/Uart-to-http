<button>Test</button>
<button id="pauseButton">Pause Serial</button>
<button id="offButton">off Serial</button>

<script>
	let myReader = null;
	let isPaused = false;


	
	document.querySelector('button').addEventListener('click', connectSerial);
	document.getElementById('pauseButton').addEventListener('click', pauseSerial);
	document.getElementById('offButton').addEventListener('click', stop);

	
	
	function stop() {
		if (myReader) {
			myReader.cancel();
			if (myReader.releaseLock) {
				myReader.releaseLock();
				console.log("端口关闭");
			}
			myReader = null;
		}
	}

	// 打开串行端口
	async function connectSerial() {
		const port = await navigator.serial.requestPort();
		await port.open({ baudRate: 115200 });

		const reader = port.readable.getReader();
		myReader = reader;
		const decoder = new TextDecoder("utf-8");
		let buffer = '';

		try {
			while (true) {
				if (isPaused) {
					await new Promise(resolve => setTimeout(resolve, 10));
					continue;
				}

				const { value, done } = await reader.read();

				if (done) {
					break;
				}

				if (value) {
					const text = decoder.decode(value, { stream: true });
					buffer += text;
					processBuffer(buffer, value);
				}
			}
		} catch (error) {
			console.error(error);
		} finally {
			if (reader) {
				reader.releaseLock();
			}
			if (port) {
				await port.close();
			}
		}
	}

	const hexEncode = (value) => {
		return Array.from(value, (byte) =>
			byte.toString(16).padStart(2, "0"),
		).join(",");
	}

	function processLine(line, value) {
		const now = new Date();
		const timestamp = `[${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}.${now.getMilliseconds()}]`;
		const hexValue = hexEncode(value);
		console.log(`${timestamp} ${line}`, hexValue);
	}

	
	function processBuffer(buffer, value) {
		let start = 0;
		let end = 0;

		while (end < buffer.length) {
			const eolIndex = buffer.indexOf('\r\n', end);
			if (eolIndex === -1) {
				break;
			}
			end = eolIndex + 2;
			const line = buffer.slice(start, end);
			processLine(line, value);
			start = end;
		}

		buffer = buffer.slice(start);
	}

	
		function pauseSerial() {
			isPaused = !isPaused;
			const pauseButton = document.getElementById('pauseButton');
			pauseButton.textContent = isPaused ? 'Resume Serial' : 'Pause Serial';
		}
	
</script>